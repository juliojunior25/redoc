import chalk from 'chalk';
import * as fs from 'fs/promises';
import * as path from 'path';
import { spawn } from 'child_process';
import { ConfigManager } from '../utils/config.js';

const DEFAULT_TEMPLATE = `# {PROJECT_NAME} - Documentation

<!--
  ReDoc Custom Template

  Available variables:
  - {TITLE}: Generated title (from branch/commit message)
  - {PROJECT_NAME}: Name of the project
  - {BRANCH_NAME}: Current branch name
  - {DATE}: Generation date
  - {CREATED_AT}: Generation date (same as {DATE})
  - {GENERATED_AT}: Full timestamp
  - {COMMIT_COUNT}: Number of commits
  - {COMMITS_SUMMARY}: Summary of commits
  - {COMMITS_LIST}: Alias of {COMMITS_SUMMARY}
  - {BRAIN_DUMP}: Brain dump answers
  - {WHAT_AND_WHY}: Single section content
  - {KEY_DECISIONS}: Single section content
  - {GOTCHAS}: Single section content
  - {ADDITIONAL_CONTEXT}: Single section content
  - {CHANGES_DETAIL}: Detailed changes from commits
  - {FILES_LIST}: List of modified files

  Feel free to customize this template as you wish.
  The sections below are suggestions - modify or remove as needed.
-->

## Overview

{BRAIN_DUMP}

## Changes Summary

{COMMITS_SUMMARY}

## Technical Details

{CHANGES_DETAIL}

## Files

{FILES_LIST}

---
*Generated by ReDoc on {GENERATED_AT}*
`;

/**
 * Template command - create or edit documentation template
 */
export async function templateCommand(): Promise<void> {
  const configManager = new ConfigManager();

  // Check if ReDoc is initialized
  const isInitialized = await configManager.isInitialized();
  if (!isInitialized) {
    console.log(chalk.red('Error: ReDoc is not initialized.'));
    console.log(chalk.gray('Run "redoc init" first.'));
    process.exit(1);
  }

  const config = await configManager.load();
  const projectRoot = process.cwd();
  const templateFile = '.redoc-template.md';
  const templatePath = config.templatePath || path.join(projectRoot, templateFile);

  // Check if template file exists
  let templateExists = false;
  try {
    await fs.access(templatePath);
    templateExists = true;
  } catch {
    // File doesn't exist
  }

  // Create template if it doesn't exist
  if (!templateExists) {
    console.log(chalk.blue('Creating new template file...'));
    await fs.writeFile(templatePath, DEFAULT_TEMPLATE, 'utf-8');
    console.log(chalk.green(`✓ Template created at ${templateFile}`));

    // Update config with template path
    await configManager.update({ templatePath });
  }

  // Get editor from config or environment
  const editor = config.editor || process.env.EDITOR || 'nano';

  console.log(chalk.blue(`\nOpening template in ${editor}...\n`));
  console.log(chalk.gray('Available variables:'));
  console.log(chalk.gray('  {TITLE}           - Generated title'));
  console.log(chalk.gray('  {PROJECT_NAME}    - Name of the project'));
  console.log(chalk.gray('  {BRANCH_NAME}     - Current branch name'));
  console.log(chalk.gray('  {DATE}            - Generation date'));
  console.log(chalk.gray('  {CREATED_AT}      - Generation date (alias of {DATE})'));
  console.log(chalk.gray('  {GENERATED_AT}    - Full timestamp'));
  console.log(chalk.gray('  {COMMIT_COUNT}    - Number of commits'));
  console.log(chalk.gray('  {COMMITS_SUMMARY} - Summary of commits'));
  console.log(chalk.gray('  {COMMITS_LIST}    - Alias of {COMMITS_SUMMARY}'));
  console.log(chalk.gray('  {BRAIN_DUMP}      - Brain dump answers'));
  console.log(chalk.gray('  {WHAT_AND_WHY}    - Single section: what & why'));
  console.log(chalk.gray('  {KEY_DECISIONS}   - Single section: key decisions'));
  console.log(chalk.gray('  {GOTCHAS}         - Single section: gotchas'));
  console.log(chalk.gray('  {ADDITIONAL_CONTEXT} - Single section: additional context'));
  console.log(chalk.gray('  {CHANGES_DETAIL}  - Detailed changes from commits'));
  console.log(chalk.gray('  {FILES_LIST}      - List of modified files'));
  console.log('');

  // Open editor
  const editorParts = editor.split(' ');
  const editorCmd = editorParts[0];
  const editorArgs = [...editorParts.slice(1), templatePath];

  const child = spawn(editorCmd, editorArgs, {
    stdio: 'inherit',
    shell: true
  });

  child.on('close', (code) => {
    if (code === 0) {
      console.log(chalk.green('\n✓ Template saved'));
      console.log(chalk.gray(`  Path: ${templatePath}`));
    } else {
      console.log(chalk.yellow('\nEditor closed without saving or with error'));
    }
  });

  child.on('error', (error) => {
    console.log(chalk.red(`\nFailed to open editor: ${error.message}`));
    console.log(chalk.gray(`Template location: ${templatePath}`));
    console.log(chalk.gray('You can edit it manually or change your editor with:'));
    console.log(chalk.gray('  redoc config set editor "code --wait"'));
  });
}
